#include "mbed.h"

I2C lcd(p28, p27);
DigitalOut reset(p26);
Serial pc(USBTX, USBRX); // tx, rx

char buffer[]={
   0x7C, 0x7E, 0x13, 0x13, 0x7E, 0x7C, 0x00, 0x00,  // 'A'
    0x41, 0x7F, 0x7F, 0x49, 0x49, 0x7F, 0x36, 0x00,  // 'B'
    0x1C, 0x3E, 0x63, 0x41, 0x41, 0x63, 0x22, 0x00,  // 'C'
    0x41, 0x7F, 0x7F, 0x41, 0x63, 0x3E, 0x1C, 0x00,  // 'D'
    0x41, 0x7F, 0x7F, 0x49, 0x5D, 0x41, 0x63, 0x00,  // 'E'
    0x41, 0x7F, 0x7F, 0x49, 0x1D, 0x01, 0x03, 0x00,  // 'F'
    0x1C, 0x3E, 0x63, 0x41, 0x51, 0x73, 0x72, 0x00,  // 'G'
    0x7F, 0x7F, 0x08, 0x08, 0x7F, 0x7F, 0x00, 0x00,  // 'H'
    0x00, 0x41, 0x7F, 0x7F, 0x41, 0x00, 0x00, 0x00,  // 'I'
    0x30, 0x70, 0x40, 0x41, 0x7F, 0x3F, 0x01, 0x00,  // 'J'
    0x41, 0x7F, 0x7F, 0x08, 0x1C, 0x77, 0x63, 0x00,  // 'K'
    0x41, 0x7F, 0x7F, 0x41, 0x40, 0x60, 0x70, 0x00,  // 'L'
    0x7F, 0x7F, 0x0E, 0x1C, 0x0E, 0x7F, 0x7F, 0x00,  // 'M'
    0x7F, 0x7F, 0x06, 0x0C, 0x18, 0x7F, 0x7F, 0x00,  // 'N'
    0x1C, 0x3E, 0x63, 0x41, 0x63, 0x3E, 0x1C, 0x00,  // 'O'
    0x41, 0x7F, 0x7F, 0x49, 0x09, 0x0F, 0x06, 0x00,  // 'P'
    0x1E, 0x3F, 0x21, 0x71, 0x7F, 0x5E, 0x00, 0x00,  // 'Q'
    0x41, 0x7F, 0x7F, 0x09, 0x19, 0x7F, 0x66, 0x00,  // 'R'
    0x26, 0x6F, 0x4D, 0x59, 0x73, 0x32, 0x00, 0x00,  // 'S'
    0x03, 0x41, 0x7F, 0x7F, 0x41, 0x03, 0x00, 0x00,  // 'T'
    0x7F, 0x7F, 0x40, 0x40, 0x7F, 0x7F, 0x00, 0x00,  // 'U'
    0x1F, 0x3F, 0x60, 0x60, 0x3F, 0x1F, 0x00, 0x00,  // 'V'
    0x7F, 0x7F, 0x30, 0x18, 0x30, 0x7F, 0x7F, 0x00,  // 'W'
    0x43, 0x67, 0x3C, 0x18, 0x3C, 0x67, 0x43, 0x00,  // 'X'
    0x07, 0x4F, 0x78, 0x78, 0x4F, 0x07, 0x00, 0x00,  // 'Y'
    0x47, 0x63, 0x71, 0x59, 0x4D, 0x67, 0x73, 0x00  // 'Z'
    };

void cmd(char cmd)
{
    char tmp[2];
    tmp[0]=0,tmp[1]=cmd;
    
    lcd.write(0x78,tmp,2); //add 01111000
}

void data(char d)
{
    char tmp[2];
    tmp[0]=0x40,tmp[1]=d;
    
    lcd.write(0x78,tmp,2);
}

void init_lcd()
{
    reset=1;
    wait_ms(10);
    reset=0;
    wait_ms(100);
    reset=1;
    
    lcd.frequency(400000);
    
    cmd(0xae); //turn off
    pc.printf("OK!\n");
    
    cmd(0x00);
    cmd(0x10); // set column address
    
    cmd(0x40); //set start line
    
    cmd(0x81);
    cmd(0xcf); //set contrast
    
    cmd(0xa0); //remap
    cmd(0xa6); //normal mode
    
    cmd(0x20);
    cmd(0x00); //memory mode
    
    cmd(0xa8);
    cmd(0x3f); //multiplex ratio
    
    cmd(0xd3);
    cmd(0x00); //init offset
    
    cmd(0xd5);
    cmd(0x80); //set divide clock
    
    cmd(0xd9);
    cmd(0xf1); //pre charge
    
    cmd(0xda);
    cmd(0x12); //hw pin config
    
    cmd(0xdb);
    cmd(0x40); //vcomh
    
    cmd(0x8d);
    cmd(0x14);
    cmd(0xa4);
    cmd(0xa6);
    cmd(0xaf); //turn on
    
}

int main()
{
    init_lcd();
    
    char tmp[2]={0x40,0xff};
    
    for(int i=0;i<208;i++)
    {
        tmp[1]=buffer[i];
        lcd.write(0x78,tmp,2);
    }   
    
}
